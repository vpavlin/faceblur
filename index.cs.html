<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NÃ¡stroj na ochranu soukromÃ­ obliÄejÅ¯ ğŸ­</title>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            color: #333;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 800px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }
        
        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
        }
        
        .upload-area:hover {
            background: #f0f0ff;
            border-color: #764ba2;
        }
        
        .upload-area input {
            display: none;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
        }
        
        button:hover {
            background: #764ba2;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .canvas-container {
            display: flex;
            justify-content: center;
            margin: 20px 0;
            position: relative;
        }
        
        canvas {
            max-width: 100%;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .status {
            text-align: center;
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            font-weight: bold;
        }
        
        .status.loading {
            background: #fff3cd;
            color: #856404;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .info {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .emoji-selector {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .emoji-btn {
            font-size: 32px;
            padding: 10px;
            background: white;
            border: 2px solid #667eea;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s;
            min-width: 60px;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .emoji-btn:hover {
            transform: scale(1.1);
        }
        
        .emoji-btn.selected {
            background: #667eea;
            transform: scale(1.15);
        }
        
        .emoji-btn img {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 4px;
        }
        
        .custom-image-upload {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: none;
        }
        
        .custom-image-upload label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #667eea;
        }
        
        .custom-image-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
            margin-right: 10px;
        }
        
        .custom-image-btn:hover {
            background: #764ba2;
        }
        
        .custom-images-gallery {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        .custom-image-item {
            position: relative;
            width: 60px;
            height: 60px;
        }
        
        .custom-image-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid #667eea;
            cursor: pointer;
        }
        
        .custom-image-item .delete-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            background: red;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }
        
        .sensitivity-control {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: none;
        }
        
        .sensitivity-control label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #667eea;
        }
        
        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .slider {
            flex: 1;
            height: 8px;
            border-radius: 4px;
            background: #ddd;
            outline: none;
            -webkit-appearance: none;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
        }
        
        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: none;
        }
        
        .slider-value {
            min-width: 80px;
            text-align: center;
            font-weight: bold;
            color: #667eea;
        }
        
        .face-toggle {
            position: absolute;
            background: rgba(255, 0, 0, 0.8);
            color: white;
            border: 2px solid white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: bold;
            font-size: 18px;
            transition: all 0.2s;
            user-select: none;
        }
        
        .face-toggle:hover {
            transform: scale(1.2);
            background: rgba(200, 0, 0, 1);
        }
        
        .face-toggle.disabled {
            background: rgba(100, 100, 100, 0.8);
        }
        
        .face-toggle.disabled:hover {
            background: rgba(80, 80, 80, 1);
        }
        
        .language-switcher {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        
        .language-switcher a {
            display: inline-block;
            padding: 8px 16px;
            background: white;
            color: #667eea;
            text-decoration: none;
            border-radius: 8px;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transition: all 0.3s;
        }
        
        .language-switcher a:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body>
    <div class="language-switcher">
        <a href="index.html">ğŸ‡¬ğŸ‡§ English</a>
    </div>
    <div class="container">
        <h1>ğŸ­ NÃ¡stroj na ochranu soukromÃ­ obliÄejÅ¯</h1>
        <p class="subtitle">ChraÅˆte svÃ© soukromÃ­ rozmazÃ¡nÃ­m nebo skrytÃ­m obliÄejÅ¯ na fotografiÃ­ch - vÅ¡e se dÄ›je ve vaÅ¡em zaÅ™Ã­zenÃ­!</p>
        
        <div class="upload-area" id="uploadArea">
            <h2>ğŸ“¸ Vyberte nebo vyfoÅ¥te fotografii</h2>
            <p>Vyberte, jak chcete poskytnout obrÃ¡zek</p>
            <input type="file" id="imageInput" accept="image/*" style="display: none;">
            <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display: none;">
            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 15px; flex-wrap: wrap;">
                <button id="galleryBtn" style="background: #667eea;">ğŸ“ Vybrat z galerie</button>
                <button id="cameraBtn" style="background: #764ba2;">ğŸ“· Vyfotit</button>
            </div>
        </div>
        
        <div class="sensitivity-control" id="sensitivityControl">
            <label>ğŸ¯ Citlivost detekce</label>
            <div class="slider-container">
                <span>MÃ©nÄ›</span>
                <input type="range" min="0.1" max="0.9" step="0.05" value="0.5" class="slider" id="sensitivitySlider">
                <span>VÃ­ce</span>
                <span class="slider-value" id="sliderValue">0.50</span>
            </div>
            <button id="redetectBtn" style="margin-top: 10px; width: 100%;">ğŸ”„ Znovu detekovat obliÄeje</button>
        </div>
        
        <div class="custom-image-upload" id="customImageUpload">
            <label>ğŸ–¼ï¸ VlastnÃ­ obrÃ¡zky</label>
            <input type="file" id="customImageInput" accept="image/*" style="display: none;">
            <button class="custom-image-btn" id="uploadCustomBtn">ğŸ“¤ NahrÃ¡t vlastnÃ­ obrÃ¡zek</button>
            <button class="custom-image-btn" id="clearCustomBtn" style="background: #dc3545;">ğŸ—‘ï¸ Smazat vÅ¡e</button>
            <div class="custom-images-gallery" id="customImagesGallery"></div>
        </div>
        
        <div class="emoji-selector" id="emojiSelector" style="display: none;">
            <button class="emoji-btn" data-emoji="ğŸ˜€">ğŸ˜€</button>
            <button class="emoji-btn" data-emoji="ğŸ˜">ğŸ˜</button>
            <button class="emoji-btn" data-emoji="ğŸ¤–">ğŸ¤–</button>
            <button class="emoji-btn selected" data-emoji="ğŸ˜Š">ğŸ˜Š</button>
            <button class="emoji-btn" data-emoji="ğŸ­">ğŸ­</button>
            <button class="emoji-btn" data-emoji="ğŸ˜‚">ğŸ˜‚</button>
            <button class="emoji-btn" data-emoji="ğŸ¥³">ğŸ¥³</button>
            <button class="emoji-btn" data-emoji="ğŸ˜‡">ğŸ˜‡</button>
            <button class="emoji-btn" data-emoji="ğŸ¤©">ğŸ¤©</button>
            <button class="emoji-btn" data-emoji="ğŸ˜´">ğŸ˜´</button>
            <button class="emoji-btn" data-emoji="ğŸ¤”">ğŸ¤”</button>
            <button class="emoji-btn" data-emoji="ğŸ˜±">ğŸ˜±</button>
            <button class="emoji-btn" data-emoji="ğŸ‘½">ğŸ‘½</button>
            <button class="emoji-btn" data-emoji="ğŸ‘»">ğŸ‘»</button>
            <button class="emoji-btn" data-emoji="ğŸƒ">ğŸƒ</button>
            <button class="emoji-btn" data-emoji="ğŸ’€">ğŸ’€</button>
            <button class="emoji-btn" data-emoji="ğŸ¶">ğŸ¶</button>
            <button class="emoji-btn" data-emoji="ğŸ±">ğŸ±</button>
            <button class="emoji-btn" data-emoji="ğŸ¼">ğŸ¼</button>
            <button class="emoji-btn" data-emoji="ğŸ¦„">ğŸ¦„</button>
        </div>
        
        <div class="controls" style="display: none;" id="controls">
            <button id="blurBtn">ğŸŒ«ï¸ Rozmazat obliÄeje</button>
            <button id="emojiBtn">ğŸ˜Š Emoji obliÄeje</button>
            <button id="downloadBtn" style="display: none;">ğŸ’¾ StÃ¡hnout</button>
        </div>
        
        <div class="canvas-container" id="canvasContainer">
            <canvas id="canvas"></canvas>
        </div>
        
        <div id="status"></div>
        
        <div class="info">
            <strong>ğŸ”’ Jak to funguje:</strong><br>
            1ï¸âƒ£ Vyberte fotografii ze svÃ©ho zaÅ™Ã­zenÃ­ nebo vyfoÅ¥te novou fotoaparÃ¡tem<br>
            2ï¸âƒ£ UmÄ›lÃ¡ inteligence automaticky detekuje vÅ¡echny obliÄeje (dÄ›je se ve VAÅ EM zaÅ™Ã­zenÃ­)<br>
            3ï¸âƒ£ KliknÄ›te na ÄervenÃ© tlaÄÃ­tko âœ• u jakÃ©hokoliv obliÄeje, abyste ho vylouÄili ze zpracovÃ¡nÃ­<br>
            4ï¸âƒ£ Vyberte si z vÃ­ce neÅ¾ 20 emoji nebo nahrajte vlastnÃ­ obrÃ¡zky<br>
            5ï¸âƒ£ KliknÄ›te pro rozmazÃ¡nÃ­ obliÄejÅ¯ nebo jejich nahrazenÃ­ emoji/obrÃ¡zky (pouze povolenÃ© obliÄeje)<br>
            6ï¸âƒ£ StÃ¡hnÄ›te si svou fotografii chrÃ¡nÄ›nou soukromÃ­m!<br><br>
            <strong>âœ¨ SoukromÃ­ na prvnÃ­m mÃ­stÄ›:</strong> VeÅ¡kerÃ© zpracovÃ¡nÃ­ probÃ­hÃ¡ ve vaÅ¡em prohlÃ­Å¾eÄi. Å½Ã¡dnÃ© fotografie nejsou odesÃ­lÃ¡ny na Å¾Ã¡dnÃ½ server!<br>
            <strong>ğŸ–¼ï¸ VlastnÃ­ obrÃ¡zky:</strong> Nahrajte si vlastnÃ­ obrÃ¡zky pro zakrytÃ­ obliÄejÅ¯ - jsou uloÅ¾eny lokÃ¡lnÄ› ve vaÅ¡em prohlÃ­Å¾eÄi!
        </div>
    </div>

    <script>
        // GlobÃ¡lnÃ­ promÄ›nnÃ©
        let selectedEmoji = 'ğŸ˜Š';
        let selectedCustomImage = null; // Pro reÅ¾im vlastnÃ­ch obrÃ¡zkÅ¯
        let faceDetections = [];
        let disabledFaces = []; // SledovÃ¡nÃ­, kterÃ© obliÄeje jsou zakÃ¡zanÃ©
        let originalImage = null;
        let modelsLoaded = false;
        let detectionThreshold = 0.5;
        let customImages = []; // UloÅ¾enÃ­ vlastnÃ­ch obrÃ¡zkÅ¯
        
        // DOM elementy
        const uploadArea = document.getElementById('uploadArea');
        const imageInput = document.getElementById('imageInput');
        const cameraInput = document.getElementById('cameraInput');
        const galleryBtn = document.getElementById('galleryBtn');
        const cameraBtn = document.getElementById('cameraBtn');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const status = document.getElementById('status');
        const controls = document.getElementById('controls');
        const blurBtn = document.getElementById('blurBtn');
        const emojiBtn = document.getElementById('emojiBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const emojiSelector = document.getElementById('emojiSelector');
        const sensitivityControl = document.getElementById('sensitivityControl');
        const sensitivitySlider = document.getElementById('sensitivitySlider');
        const sliderValue = document.getElementById('sliderValue');
        const redetectBtn = document.getElementById('redetectBtn');
        const canvasContainer = document.getElementById('canvasContainer');
        const customImageUpload = document.getElementById('customImageUpload');
        const customImageInput = document.getElementById('customImageInput');
        const uploadCustomBtn = document.getElementById('uploadCustomBtn');
        const clearCustomBtn = document.getElementById('clearCustomBtn');
        const customImagesGallery = document.getElementById('customImagesGallery');
        
        // Zobrazit stavovou zprÃ¡vu
        function showStatus(message, type) {
            status.textContent = message;
            status.className = `status ${type}`;
            status.style.display = 'block';
        }
        
        // NaÄÃ­st vlastnÃ­ obrÃ¡zky z localStorage
        function loadCustomImages() {
            const stored = localStorage.getItem('faceblur_custom_images');
            if (stored) {
                try {
                    customImages = JSON.parse(stored);
                    renderCustomImagesGallery();
                } catch (e) {
                    console.error('Chyba pÅ™i naÄÃ­tÃ¡nÃ­ vlastnÃ­ch obrÃ¡zkÅ¯:', e);
                    customImages = [];
                }
            }
        }
        
        // UloÅ¾it vlastnÃ­ obrÃ¡zky do localStorage
        function saveCustomImages() {
            try {
                localStorage.setItem('faceblur_custom_images', JSON.stringify(customImages));
            } catch (e) {
                console.error('Chyba pÅ™i uklÃ¡dÃ¡nÃ­ vlastnÃ­ch obrÃ¡zkÅ¯:', e);
                showStatus('âš ï¸ DosaÅ¾en limit ÃºloÅ¾iÅ¡tÄ›. ProsÃ­m smaÅ¾te nÄ›kterÃ© obrÃ¡zky.', 'error');
            }
        }
        
        // Vykreslit galerii vlastnÃ­ch obrÃ¡zkÅ¯
        function renderCustomImagesGallery() {
            customImagesGallery.innerHTML = '';
            customImages.forEach((imgData, index) => {
                const item = document.createElement('div');
                item.className = 'custom-image-item';
                
                const img = document.createElement('img');
                img.src = imgData;
                img.onclick = () => selectCustomImage(imgData);
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.textContent = 'Ã—';
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    deleteCustomImage(index);
                };
                
                item.appendChild(img);
                item.appendChild(deleteBtn);
                customImagesGallery.appendChild(item);
            });
        }
        
        // Vybrat vlastnÃ­ obrÃ¡zek
        function selectCustomImage(imgData) {
            selectedCustomImage = imgData;
            selectedEmoji = null;
            
            // ZruÅ¡it vÃ½bÄ›r vÅ¡ech emoji tlaÄÃ­tek
            document.querySelectorAll('.emoji-btn').forEach(b => b.classList.remove('selected'));
            
            // Automaticky pÅ™ekreslit, pokud jsou vlastnÃ­ obrÃ¡zky jiÅ¾ aplikovÃ¡ny
            if (originalImage && faceDetections.length > 0 && downloadBtn.style.display === 'block') {
                applyEmojiOrImage();
                showStatus('âœ… VlastnÃ­ obrÃ¡zek aktualizovÃ¡n!', 'success');
            } else {
                showStatus('âœ… VlastnÃ­ obrÃ¡zek vybrÃ¡n! KliknÄ›te na "ğŸ˜Š Emoji obliÄeje" pro aplikaci.', 'success');
            }
        }
        
        // Smazat vlastnÃ­ obrÃ¡zek
        function deleteCustomImage(index) {
            customImages.splice(index, 1);
            saveCustomImages();
            renderCustomImagesGallery();
            
            if (customImages.length === 0) {
                selectedCustomImage = null;
            }
            
            showStatus('ğŸ—‘ï¸ VlastnÃ­ obrÃ¡zek smazÃ¡n', 'success');
        }
        
        // VytvoÅ™it pÅ™epÃ­nacÃ­ tlaÄÃ­tka pro kaÅ¾dÃ½ obliÄej
        function createFaceToggles() {
            // Odstranit existujÃ­cÃ­ pÅ™epÃ­naÄe
            document.querySelectorAll('.face-toggle').forEach(el => el.remove());
            
            if (!faceDetections.length) return;
            
            const canvasRect = canvas.getBoundingClientRect();
            const scaleX = canvasRect.width / canvas.width;
            const scaleY = canvasRect.height / canvas.height;
            
            faceDetections.forEach((detection, index) => {
                const box = detection.detection.box;
                const toggle = document.createElement('div');
                toggle.className = 'face-toggle';
                toggle.textContent = 'âœ•';
                toggle.dataset.index = index;
                
                // UmÃ­stit v pravÃ©m hornÃ­m rohu rÃ¡meÄku obliÄeje
                const left = canvasRect.left + (box.x + box.width - 15) * scaleX;
                const top = canvasRect.top + (box.y - 15) * scaleY;
                
                toggle.style.left = `${left}px`;
                toggle.style.top = `${top}px`;
                
                // Zkontrolovat, zda je obliÄej zakÃ¡zÃ¡n
                if (disabledFaces[index]) {
                    toggle.classList.add('disabled');
                }
                
                toggle.addEventListener('click', () => toggleFace(index));
                
                document.body.appendChild(toggle);
            });
        }
        
        // PÅ™epnout stav obliÄeje povoleno/zakÃ¡zÃ¡no
        function toggleFace(index) {
            disabledFaces[index] = !disabledFaces[index];
            
            // Aktualizovat vzhled pÅ™epÃ­nacÃ­ho tlaÄÃ­tka
            const toggle = document.querySelector(`.face-toggle[data-index="${index}"]`);
            if (toggle) {
                toggle.classList.toggle('disabled');
            }
            
            // PÅ™ekreslit nÃ¡hled s aktualizovanÃ½m stavem
            drawFacePreview();
            
            const enabledCount = faceDetections.length - disabledFaces.filter(d => d).length;
            showStatus(`âœ… ${enabledCount} z ${faceDetections.length} obliÄejÅ¯ bude zpracovÃ¡no`, 'success');
        }
        
        // Nakreslit nÃ¡hled obliÄeje s rÃ¡meÄky
        function drawFacePreview() {
            if (!originalImage) return;
            
            ctx.drawImage(originalImage, 0, 0);
            
            faceDetections.forEach((detection, index) => {
                const box = detection.detection.box;
                
                if (disabledFaces[index]) {
                    // Nakreslit ÄervenÃ½ kÅ™Ã­Å¾ek pÅ™es zakÃ¡zanÃ© obliÄeje
                    ctx.strokeStyle = 'rgba(255, 0, 0, 0.6)';
                    ctx.lineWidth = 4;
                    ctx.strokeRect(box.x, box.y, box.width, box.height);
                    
                    // Nakreslit X
                    ctx.beginPath();
                    ctx.moveTo(box.x, box.y);
                    ctx.lineTo(box.x + box.width, box.y + box.height);
                    ctx.moveTo(box.x + box.width, box.y);
                    ctx.lineTo(box.x, box.y + box.height);
                    ctx.stroke();
                } else {
                    // Nakreslit normÃ¡lnÃ­ modrÃ½ rÃ¡meÄek pro povolenÃ© obliÄeje
                    ctx.strokeStyle = '#667eea';
                    ctx.lineWidth = 3;
                    ctx.strokeRect(box.x, box.y, box.width, box.height);
                }
            });
        }
        
        // NaÄÃ­st modely pro detekci obliÄejÅ¯
        async function loadModels() {
            showStatus('ğŸ”„ NaÄÃ­tÃ¡nÃ­ AI modelÅ¯ (mÅ¯Å¾e to chvÃ­li trvat)...', 'loading');
            try {
                const MODEL_URL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/';
                await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
                await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
                modelsLoaded = true;
                showStatus('âœ… AI modely naÄteny! PÅ™ipraveno chrÃ¡nit soukromÃ­!', 'success');
                setTimeout(() => status.style.display = 'none', 3000);
            } catch (error) {
                showStatus('âŒ Chyba pÅ™i naÄÃ­tÃ¡nÃ­ modelÅ¯: ' + error.message, 'error');
                console.error('Chyba naÄÃ­tÃ¡nÃ­ modelu:', error);
            }
        }
        
        // ObslouÅ¾it tlaÄÃ­tko galerie
        galleryBtn.addEventListener('click', () => {
            if (!modelsLoaded) {
                showStatus('â³ ProsÃ­m poÄkejte na naÄtenÃ­ AI modelÅ¯...', 'loading');
                return;
            }
            imageInput.click();
        });
        
        // ObslouÅ¾it tlaÄÃ­tko fotoaparÃ¡tu
        cameraBtn.addEventListener('click', () => {
            if (!modelsLoaded) {
                showStatus('â³ ProsÃ­m poÄkejte na naÄtenÃ­ AI modelÅ¯...', 'loading');
                return;
            }
            cameraInput.click();
        });
        
        // Funkce pro detekci obliÄejÅ¯
        async function detectFaces() {
            if (!originalImage) return;
            
            // Nakreslit pÅ¯vodnÃ­ obrÃ¡zek
            ctx.drawImage(originalImage, 0, 0);
            
            // Detekovat obliÄeje
            showStatus('ğŸ” Detekuji obliÄeje...', 'loading');
            try {
                faceDetections = await faceapi.detectAllFaces(
                    originalImage, 
                    new faceapi.TinyFaceDetectorOptions({
                        inputSize: 416,
                        scoreThreshold: detectionThreshold
                    })
                ).withFaceLandmarks();
                
                if (faceDetections.length > 0) {
                    // Inicializovat pole zakÃ¡zanÃ½ch obliÄejÅ¯ (vÅ¡echny povoleny ve vÃ½chozÃ­m nastavenÃ­)
                    disabledFaces = new Array(faceDetections.length).fill(false);
                    
                    showStatus(`âœ… Nalezeno ${faceDetections.length} obliÄejÅ¯! KliknÄ›te na X pro vylouÄenÃ­ obliÄejÅ¯, pak aplikujte rozmazÃ¡nÃ­/emoji.`, 'success');
                    controls.style.display = 'flex';
                    emojiSelector.style.display = 'flex';
                    customImageUpload.style.display = 'block';
                    
                    // Nakreslit nÃ¡hled s rÃ¡meÄky
                    drawFacePreview();
                    
                    // VytvoÅ™it pÅ™epÃ­nacÃ­ tlaÄÃ­tka
                    createFaceToggles();
                } else {
                    showStatus('ğŸ˜• Å½Ã¡dnÃ© obliÄeje nebyly detekovÃ¡ny. Zkuste upravit posuvnÃ­k citlivosti.', 'error');
                    controls.style.display = 'none';
                    emojiSelector.style.display = 'none';
                    customImageUpload.style.display = 'none';
                    disabledFaces = [];
                }
            } catch (error) {
                showStatus('âŒ Chyba pÅ™i detekci obliÄejÅ¯: ' + error.message, 'error');
                console.error('Chyba detekce obliÄejÅ¯:', error);
            }
        }
        
        // ObslouÅ¾it naÄÃ­tÃ¡nÃ­ obrÃ¡zku (sdÃ­lenÃ¡ funkce pro oba vstupy)
        async function handleImageFile(file) {
            if (!file) return;
            
            if (!modelsLoaded) {
                showStatus('â³ ProsÃ­m poÄkejte na naÄtenÃ­ AI modelÅ¯...', 'loading');
                return;
            }
            
            showStatus('ğŸ“· NaÄÃ­tÃ¡m obrÃ¡zek...', 'loading');
            
            const img = new Image();
            img.onload = async () => {
                originalImage = img;
                
                // ZmÄ›nit velikost plÃ¡tna podle obrÃ¡zku
                canvas.width = img.width;
                canvas.height = img.height;
                
                // Zobrazit ovlÃ¡dÃ¡nÃ­ citlivosti
                sensitivityControl.style.display = 'block';
                
                // Detekovat obliÄeje
                await detectFaces();
            };
            
            img.src = URL.createObjectURL(file);
        }
        
        // ObslouÅ¾it vstup z galerie
        imageInput.addEventListener('change', async (e) => {
            await handleImageFile(e.target.files[0]);
        });
        
        // ObslouÅ¾it vstup z fotoaparÃ¡tu
        cameraInput.addEventListener('change', async (e) => {
            await handleImageFile(e.target.files[0]);
        });
        
        // PosuvnÃ­k citlivosti
        sensitivitySlider.addEventListener('input', (e) => {
            detectionThreshold = parseFloat(e.target.value);
            sliderValue.textContent = detectionThreshold.toFixed(2);
        });
        
        // TlaÄÃ­tko pro opÄ›tovnou detekci
        redetectBtn.addEventListener('click', async () => {
            if (originalImage) {
                await detectFaces();
            }
        });
        
        // Obsluha nahrÃ¡vÃ¡nÃ­ vlastnÃ­ch obrÃ¡zkÅ¯
        uploadCustomBtn.addEventListener('click', () => {
            customImageInput.click();
        });
        
        customImageInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (event) => {
                const imgData = event.target.result;
                customImages.push(imgData);
                saveCustomImages();
                renderCustomImagesGallery();
                showStatus('âœ… VlastnÃ­ obrÃ¡zek nahrÃ¡n!', 'success');
            };
            reader.readAsDataURL(file);
            
            // Resetovat vstup
            e.target.value = '';
        });
        
        clearCustomBtn.addEventListener('click', () => {
            if (confirm('Opravdu chcete smazat vÅ¡echny vlastnÃ­ obrÃ¡zky?')) {
                customImages = [];
                selectedCustomImage = null;
                saveCustomImages();
                renderCustomImagesGallery();
                showStatus('ğŸ—‘ï¸ VÅ¡echny vlastnÃ­ obrÃ¡zky smazÃ¡ny', 'success');
            }
        });
        
        // VÃ½bÄ›r emoji
        document.querySelectorAll('.emoji-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('.emoji-btn').forEach(b => b.classList.remove('selected'));
                e.target.classList.add('selected');
                selectedEmoji = e.target.dataset.emoji;
                selectedCustomImage = null; // Vymazat vÃ½bÄ›r vlastnÃ­ho obrÃ¡zku
                
                // Automaticky pÅ™ekreslit, pokud jsou emoji jiÅ¾ aplikovÃ¡na
                if (originalImage && faceDetections.length > 0 && downloadBtn.style.display === 'block') {
                    applyEmojiOrImage();
                    showStatus('âœ… Emoji aktualizovÃ¡no!', 'success');
                }
            });
        });
        
        // Rozmazat obliÄeje
        blurBtn.addEventListener('click', () => {
            if (!originalImage || faceDetections.length === 0) return;
            
            // PÅ™ekreslit pÅ¯vodnÃ­ obrÃ¡zek
            ctx.drawImage(originalImage, 0, 0);
            
            let processedCount = 0;
            
            // Rozmazat kaÅ¾dÃ½ detekovanÃ½ obliÄej (pÅ™eskoÄit zakÃ¡zanÃ©)
            faceDetections.forEach((detection, index) => {
                if (disabledFaces[index]) return; // PÅ™eskoÄit zakÃ¡zanÃ© obliÄeje
                
                const box = detection.detection.box;
                
                // MÃ­rnÄ› rozÅ¡Ã­Å™it rÃ¡meÄek pro lepÅ¡Ã­ pokrytÃ­
                const padding = 20;
                const x = Math.max(0, box.x - padding);
                const y = Math.max(0, box.y - padding);
                const width = Math.min(canvas.width - x, box.width + padding * 2);
                const height = Math.min(canvas.height - y, box.height + padding * 2);
                
                // Extrahovat oblast obliÄeje
                const imageData = ctx.getImageData(x, y, width, height);
                
                // Aplikovat rozmazÃ¡nÃ­ zmenÅ¡enÃ­m a zvÄ›tÅ¡enÃ­m
                const tempCanvas = document.createElement('canvas');
                const tempCtx = tempCanvas.getContext('2d');
                tempCanvas.width = width;
                tempCanvas.height = height;
                tempCtx.putImageData(imageData, 0, 0);
                
                // Efekt rozmazÃ¡nÃ­
                ctx.filter = 'blur(20px)';
                ctx.drawImage(tempCanvas, 0, 0, width, height, x, y, width, height);
                ctx.filter = 'none';
                
                processedCount++;
            });
            
            // Odstranit pÅ™epÃ­nacÃ­ tlaÄÃ­tka po zpracovÃ¡nÃ­
            document.querySelectorAll('.face-toggle').forEach(el => el.remove());
            
            showStatus(`âœ… ${processedCount} obliÄejÅ¯ rozmazÃ¡no!`, 'success');
            downloadBtn.style.display = 'block';
        });
        
        // Aplikovat emoji nebo vlastnÃ­ obrÃ¡zek na obliÄeje
        function applyEmojiOrImage() {
            if (!originalImage || faceDetections.length === 0) return;
            
            // PÅ™ekreslit pÅ¯vodnÃ­ obrÃ¡zek
            ctx.drawImage(originalImage, 0, 0);
            
            let processedCount = 0;
            
            if (selectedCustomImage) {
                // PouÅ¾Ã­t vlastnÃ­ obrÃ¡zek
                const customImg = new Image();
                customImg.onload = () => {
                    faceDetections.forEach((detection, index) => {
                        if (disabledFaces[index]) return; // PÅ™eskoÄit zakÃ¡zanÃ© obliÄeje
                        
                        const box = detection.detection.box;
                        const size = Math.max(box.width, box.height) * 1.2;
                        
                        // Nakreslit vlastnÃ­ obrÃ¡zek vycentrovanÃ½ na obliÄej
                        ctx.drawImage(
                            customImg,
                            box.x + box.width / 2 - size / 2,
                            box.y + box.height / 2 - size / 2,
                            size,
                            size
                        );
                        
                        processedCount++;
                    });
                    
                    // Odstranit pÅ™epÃ­nacÃ­ tlaÄÃ­tka po zpracovÃ¡nÃ­
                    document.querySelectorAll('.face-toggle').forEach(el => el.remove());
                    
                    showStatus(`âœ… ${processedCount} obliÄejÅ¯ nahrazeno vlastnÃ­m obrÃ¡zkem!`, 'success');
                    downloadBtn.style.display = 'block';
                };
                customImg.src = selectedCustomImage;
            } else {
                // PouÅ¾Ã­t emoji
                faceDetections.forEach((detection, index) => {
                    if (disabledFaces[index]) return; // PÅ™eskoÄit zakÃ¡zanÃ© obliÄeje
                    
                    const box = detection.detection.box;
                    const size = Math.max(box.width, box.height) * 1.2;
                    
                    ctx.font = `${size}px Arial`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(
                        selectedEmoji, 
                        box.x + box.width / 2, 
                        box.y + box.height / 2
                    );
                    
                    processedCount++;
                });
                
                // Odstranit pÅ™epÃ­nacÃ­ tlaÄÃ­tka po zpracovÃ¡nÃ­
                document.querySelectorAll('.face-toggle').forEach(el => el.remove());
                
                showStatus(`âœ… ${processedCount} obliÄejÅ¯ nahrazeno emoji!`, 'success');
                downloadBtn.style.display = 'block';
            }
        }
        
        // Nahradit obliÄeje emoji nebo vlastnÃ­mi obrÃ¡zky
        emojiBtn.addEventListener('click', () => {
            if (!originalImage || faceDetections.length === 0) return;
            applyEmojiOrImage();
        });
        
        // StÃ¡hnout obrÃ¡zek
        downloadBtn.addEventListener('click', () => {
            const link = document.createElement('a');
            link.download = 'fotografie-chranena-soukromim.png';
            link.href = canvas.toDataURL();
            link.click();
            showStatus('ğŸ’¾ Fotografie staÅ¾ena!', 'success');
        });
        
        // PÅ™emÃ­stit pÅ™epÃ­nacÃ­ tlaÄÃ­tka pÅ™i zmÄ›nÄ› velikosti okna
        window.addEventListener('resize', () => {
            if (faceDetections.length > 0 && document.querySelectorAll('.face-toggle').length > 0) {
                createFaceToggles();
            }
        });
        
        // PoÄkat na naÄtenÃ­ face-api.js, pak naÄÃ­st modely
        window.addEventListener('load', () => {
            if (typeof faceapi !== 'undefined') {
                loadModels();
            } else {
                showStatus('âŒ Chyba: Knihovna pro detekci obliÄejÅ¯ se nepodaÅ™ilo naÄÃ­st', 'error');
            }
            
            // NaÄÃ­st vlastnÃ­ obrÃ¡zky z localStorage
            loadCustomImages();
        });
    </script>
</body>
</html>
